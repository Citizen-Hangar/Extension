name: Build & Package (BEPP-ready)

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Ensure dist directory
        run: mkdir -p dist

      - name: Decode `CHROME_PEM_BASE64` to chrome.pem (if provided)
        if: secrets.CHROME_PEM_BASE64 != ''
        run: |
          echo "Decoding chrome.pem from CHROME_PEM_BASE64"
          echo "${{ secrets.CHROME_PEM_BASE64 }}" | base64 -d > chrome.pem
          ls -la chrome.pem || true

      - name: Run CI packaging helper
        run: |
          chmod +x ci/bepp.sh || true
          ./ci/bepp.sh
        env:
          BEPP_API_KEY: ${{ secrets.BEPP_API_KEY }}
          CHROME_PEM_BASE64: ${{ secrets.CHROME_PEM_BASE64 }}
          FIREFOX_API_TOKEN: ${{ secrets.FIREFOX_API_TOKEN }}

      - name: Save artifacts
        uses: actions/upload-artifact@v4
        with:
          name: extension-dist
          path: dist

      - name: BEPP / Release (placeholder)
        env:
          BEPP_API_KEY: ${{ secrets.BEPP_API_KEY }}
          CHROME_PEM_BASE64: ${{ secrets.CHROME_PEM_BASE64 }}
          FIREFOX_API_TOKEN: ${{ secrets.FIREFOX_API_TOKEN }}
        run: |
          echo "This job is prepared for BEPP. Replace the following placeholder with the actual BEPP invocation."
          echo "Available artifacts: dist/*.zip dist/*.xpi"
          echo "Example approaches:"
          echo "  - Use BEPP CLI to sign/upload artifacts using BEPP_API_KEY"
          echo "  - Decode CHROME_PEM_BASE64 into chrome.pem and use a CRX packer if needed"
